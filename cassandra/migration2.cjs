const newTagTables = [
  "tx_tag_gql_by_tagsum_asc_migration_0",
  "tx_tag_gql_by_tagsum_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_target_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_bundle_id_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_bundle_id_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_target_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_owner_and_target_and_bundle_id_and_data_root_desc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_bundle_id_and_data_root_asc_migration_0",
  "tx_tag_gql_by_tagsum_and_tx_id_and_owner_and_target_and_bundle_id_and_data_root_desc_migration_0",
];

let concurrent = 0;

module.exports = async (client) => {
  const pWaitFor = (await import("p-wait-for")).default;
  // const allTables = await client.execute("describe tables");
  const KEYSPACE = process.env["KEYSPACE"]
    ? process.env["KEYSPACE"]
    : "gateway";
  let warned = false;

  for (const table of newTagTables) {
    console.error("migrating " + table);

    const result = await client.execute(
      `SELECT tx_id,tx_index,owner,target,data_root FROM ${KEYSPACE}.${row.name}`,
      [],
      { prepare: true }
    );

    for await (const rowRes of result) {
      const [bucketNumericString] = rowRes.bucket_id.match(/\d+$/);
      const bucket_number = Number.parseInt(bucketNumericString);
      const [query, params] = insertQueries[row.name](KEYSPACE, {
        bucket_number,
        ...rowRes,
      });
      await pWaitFor(() => concurrent < 100);
      concurrent += 1;
      client.execute(query, params, { prepare: true }).then(() => {
        concurrent -= 1;
      });
    }
    await client.execute(`DROP TABLE ${KEYSPACE}.${row.name}`, [], {
      prepare: true,
    });
  }
};
